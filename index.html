<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Travel Agency WebApp</title>
    
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1a2e;
      --card2:#121f38;
      --text:#e6eefc;
      --muted:#9fb2d3;
      --line:rgba(255,255,255,.08);
      --pri:#4f8cff;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --radius:18px;
    }
    body{background:radial-gradient(1200px 800px at 20% 10%, rgba(79,140,255,.18), transparent 55%),
                     radial-gradient(1200px 800px at 80% 0%, rgba(34,197,94,.12), transparent 55%),
                     var(--bg);
         color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .card{background:linear-gradient(180deg,var(--card),var(--card2)); border:1px solid var(--line);
          border-radius:var(--radius); box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .btn{border-radius:14px}
    .form-control,.form-select{
      background:#0b1529; color:var(--text); border:1px solid var(--line); border-radius:14px
    }
    .form-control:focus,.form-select:focus{box-shadow:0 0 0 .2rem rgba(79,140,255,.22); border-color:rgba(79,140,255,.5)}
    .table{color:var(--text)}
    .table thead th{background:#0b1529; color:var(--muted); border-bottom:1px solid var(--line); white-space:nowrap}
    .table td{border-bottom:1px solid var(--line); vertical-align:middle}
    .badge{border-radius:999px}
    .small-muted{color:var(--muted); font-size:.9rem}
    .pointer{cursor:pointer}
    .nav-pills .nav-link{border-radius:14px; color:var(--muted)}
    .nav-pills .nav-link.active{background:rgba(79,140,255,.18); color:var(--text); border:1px solid rgba(79,140,255,.28)}
    .topbar{position:sticky; top:0; z-index:99; backdrop-filter: blur(10px);
            background:rgba(11,18,32,.72); border-bottom:1px solid var(--line)}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .hidden{display:none!important}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="container py-3 d-flex align-items-center justify-content-between">
      <div>
        <div class="fw-bold">Alharbi Travel WebApp</div>
        <div class="small-muted">Admin Dashboard ‚Ä¢ Search ‚Ä¢ Add ‚Ä¢ Edit/Delete (Admin Only)</div>
      </div>
      <div class="d-flex gap-2 align-items-center">
        <span id="whoami" class="small-muted"></span>
        <button id="btnLogout" class="btn btn-outline-light btn-sm hidden">Logout</button>
      </div>
    </div>
  </div>

  <div class="container my-4">

    <!-- LOGIN -->
    <div id="viewLogin" class="row justify-content-center">
      <div class="col-12 col-md-6 col-lg-5">
        <div class="card p-4">
          <h4 class="mb-1">üîê Login</h4>
          <div class="small-muted mb-3">Users sheet se login hota hai</div>

          <div class="mb-3">
            <label class="small-muted mb-1">Username</label>
            <input id="loginUser" class="form-control" placeholder="admin / shahzad / madni...">
          </div>
          <div class="mb-3">
            <label class="small-muted mb-1">Password</label>
            <input id="loginPass" type="password" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
          </div>

          <button id="btnLogin" class="btn btn-primary w-100">Login</button>
          <div id="loginMsg" class="small-muted mt-3"></div>
        </div>
      </div>
    </div>

    <!-- APP -->
    <div id="viewApp" class="hidden">
      <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between mb-3">
        <ul class="nav nav-pills gap-2" id="tabs">
          <li class="nav-item"><button class="nav-link active" data-tab="dash">üìä Dashboard</button></li>
          <li class="nav-item"><button class="nav-link" data-tab="bookings">üìã Bookings</button></li>
          <li class="nav-item"><button class="nav-link" data-tab="add">‚ûï Add New</button></li>
          <li class="nav-item"><button class="nav-link" data-tab="customers">üë• Customers</button></li>
          <li class="nav-item"><button class="nav-link" data-tab="packages">‚úàÔ∏è Packages/Tours</button></li>
        </ul>

        <div class="d-flex gap-2">
          <button id="btnRefresh" class="btn btn-outline-light btn-sm">Refresh</button>
        </div>
      </div>

      <!-- DASHBOARD -->
      <div id="tab-dash">
        <div class="row g-3 mb-3" id="dashCards"></div>

        <div class="row g-3">
          <div class="col-12 col-lg-8">
            <div class="card p-3">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="fw-semibold">Daily Sale (Last 7 days)</div>
                <div class="small-muted" id="dashMeta"></div>
              </div>
              <canvas id="chDailySale" height="120"></canvas>
            </div>
          </div>
          <div class="col-12 col-lg-4">
            <div class="card p-3">
              <div class="fw-semibold mb-2">Quick Tips</div>
              <div class="small-muted">
                ‚Ä¢ Admin: Edit/Delete allowed<br/>
                ‚Ä¢ User: Only own branch data<br/>
                ‚Ä¢ Profit & Pending auto calculate<br/>
                ‚Ä¢ Search by Name/Mobile/PNR/Status
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- BOOKINGS -->
      <div id="tab-bookings" class="hidden">
        <div class="card p-3 mb-3">
          <div class="row g-2 align-items-end">
            <div class="col-12 col-lg-4">
              <label class="small-muted mb-1">Search</label>
              <input id="q" class="form-control" placeholder="Name / Mobile / PNR / Airline / Status">
            </div>

            <div class="col-6 col-lg-2">
              <label class="small-muted mb-1">From</label>
              <input id="fromDate" type="date" class="form-control">
            </div>

            <div class="col-6 col-lg-2">
              <label class="small-muted mb-1">To</label>
              <input id="toDate" type="date" class="form-control">
            </div>

            <div class="col-12 col-lg-2">
              <label class="small-muted mb-1">Branch (Admin)</label>
              <select id="branchFilter" class="form-select"></select>
            </div>

            <div class="col-12 col-lg-2 d-grid">
              <button id="btnSearch" class="btn btn-primary">Search</button>
            </div>
          </div>
          <div class="small-muted mt-2" id="searchMsg"></div>
        </div>

        <div class="card p-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-semibold">Results</div>
            <div class="small-muted" id="count"></div>
          </div>

          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead>
              <tr>
                <th>Branch</th>
                <th>Invoice</th>
                <th>Customer</th>
                <th>Mobile</th>
                <th>PNR</th>
                <th>Sale</th>
                <th>Profit</th>
                <th>Pending</th>
                <th>Status</th>
                <th>DateTime</th>
                <th class="text-end">Actions</th>
              </tr>
              </thead>
              <tbody id="rows"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ADD -->
      <div id="tab-add" class="hidden">
        <div class="card p-4">
          <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
            <div>
              <h5 class="mb-1">‚ûï Add New Booking</h5>
              <div class="small-muted">Profit & Pending auto calculate</div>
            </div>
            <div class="small-muted">Branch: <span id="addBranchShow" class="fw-semibold"></span></div>
          </div>

          <hr style="border-color:var(--line)">

          <div class="row g-3">
            <div class="col-12 col-lg-4">
              <label class="small-muted mb-1">Customer Name</label>
              <input id="aCustomerName" class="form-control" placeholder="Customer name">
            </div>
            <div class="col-12 col-lg-4">
              <label class="small-muted mb-1">Mobile</label>
              <input id="aMobile" class="form-control" placeholder="05xxxxxxxx">
            </div>
            <div class="col-12 col-lg-4">
              <label class="small-muted mb-1">PNR / Ticket</label>
              <input id="aPNR" class="form-control" placeholder="PNR / Ticket number">
            </div>

            <div class="col-12 col-lg-3">
              <label class="small-muted mb-1">Trip Type</label>
              <select id="aTripType" class="form-select">
                <option value="One Way">One Way</option>
                <option value="Two Way">Two Way</option>
              </select>
            </div>
            <div class="col-6 col-lg-3">
              <label class="small-muted mb-1">Travel Date</label>
              <input id="aTravelDate" type="date" class="form-control">
            </div>
            <div class="col-6 col-lg-3">
              <label class="small-muted mb-1">Return Date</label>
              <input id="aReturnDate" type="date" class="form-control">
            </div>
            <div class="col-12 col-lg-3">
              <label class="small-muted mb-1">Airline</label>
              <input id="aAirline" class="form-control" placeholder="SV / PK / etc">
            </div>

            <div class="col-6 col-lg-3">
              <label class="small-muted mb-1">Cost Price</label>
              <input id="aCost" type="number" class="form-control" value="0">
            </div>
            <div class="col-6 col-lg-3">
              <label class="small-muted mb-1">Sale Price</label>
              <input id="aSale" type="number" class="form-control" value="0">
            </div>
            <div class="col-6 col-lg-3">
              <label class="small-muted mb-1">Cash Received</label>
              <input id="aCash" type="number" class="form-control" value="0">
            </div>
            <div class="col-6 col-lg-3">
              <label class="small-muted mb-1">Payment Mode</label>
              <select id="aPayMode" class="form-select">
                <option>Cash</option>
                <option>Bank Transfer</option>
                <option>Card</option>
                <option>Other</option>
              </select>
            </div>

            <div class="col-12 col-lg-6">
              <div class="card p-3" style="border-radius:16px">
                <div class="d-flex justify-content-between">
                  <div class="small-muted">Profit</div>
                  <div class="fw-semibold" id="aProfit">0</div>
                </div>
                <div class="d-flex justify-content-between mt-2">
                  <div class="small-muted">Pending</div>
                  <div class="fw-semibold" id="aPending">0</div>
                </div>
              </div>
            </div>

            <div class="col-12 col-lg-6">
              <label class="small-muted mb-1">Booking Status</label>
              <select id="aStatus" class="form-select">
                <option>Issued</option>
                <option>On Hold</option>
                <option>Cancelled</option>
                <option>Refund</option>
              </select>

              <button id="btnAdd" class="btn btn-primary w-100 mt-3">Save Booking</button>
              <div class="small-muted mt-2" id="addMsg"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- CUSTOMERS -->
      <div id="tab-customers" class="hidden">
        <div class="card p-4">
          <h5 class="mb-1">üë• Customers List</h5>
          <div class="small-muted mb-3">Bookings se unique customers list nikalti hai</div>

          <button id="btnLoadCustomers" class="btn btn-outline-light btn-sm">Load Customers</button>
          <div class="small-muted mt-2" id="custMsg"></div>

          <div class="table-responsive mt-3">
            <table class="table table-hover align-middle mb-0">
              <thead>
              <tr>
                <th>Customer</th>
                <th>Mobile</th>
                <th>Branch</th>
                <th>Last Booking</th>
              </tr>
              </thead>
              <tbody id="custRows"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- PACKAGES -->
      <div id="tab-packages" class="hidden">
        <div class="card p-4">
          <h5 class="mb-1">‚úàÔ∏è Packages / Tours</h5>
          <div class="small-muted">
            Abhi aap ki sheet me Packages wali sheet nahi hai.<br/>
            Agar chaho to main ‚ÄúPackages‚Äù sheet add karwa ke full management (Add/Edit/Delete) bhi connect kar dunga.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- VIEW MODAL -->
  <div class="modal fade" id="modalView" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content" style="background:#0b1529;border:1px solid var(--line);border-radius:18px;color:var(--text)">
        <div class="modal-header" style="border-color:var(--line)">
          <h5 class="modal-title">üëÅÔ∏è Booking Details</h5>
          <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="viewBody"></div>
      </div>
    </div>
  </div>

  <!-- EDIT MODAL -->
  <div class="modal fade" id="modalEdit" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content" style="background:#0b1529;border:1px solid var(--line);border-radius:18px;color:var(--text)">
        <div class="modal-header" style="border-color:var(--line)">
          <h5 class="modal-title">‚úèÔ∏è Edit Booking (Admin only)</h5>
          <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="small-muted mb-2">Sheet: <span id="eSheet" class="mono"></span> ‚Ä¢ Row: <span id="eRow" class="mono"></span></div>

          <div class="row g-3">
            <div class="col-12 col-lg-4">
              <label class="small-muted mb-1">Customer Name</label>
              <input id="eCustomerName" class="form-control">
            </div>
            <div class="col-12 col-lg-4">
              <label class="small-muted mb-1">Mobile</label>
              <input id="eMobile" class="form-control">
            </div>
            <div class="col-12 col-lg-4">
              <label class="small-muted mb-1">PNR / Ticket</label>
              <input id="ePNR" class="form-control">
            </div>

            <div class="col-12 col-lg-3">
              <label class="small-muted mb-1">Trip Type</label>
              <select id="eTripType" class="form-select">
                <option value="One Way">One Way</option>
                <option value="Two Way">Two Way</option>
              </select>
            </div>
            <div class="col-6 col-lg-3">
              <label class="small-muted mb-1">Travel Date</label>
              <input id="eTravelDate" type="date" class="form-control">
            </div>
            <div class="col-6 col-lg-3">
              <label class="small-muted mb-1">Return Date</label>
              <input id="eReturnDate" type="date" class="form-control">
            </div>
            <div class="col-12 col-lg-3">
              <label class="small-muted mb-1">Airline</label>
              <input id="eAirline" class="form-control">
            </div>

            <div class="col-6 col-lg-3">
              <label class="small-muted mb-1">Cost Price</label>
              <input id="eCost" type="number" class="form-control" value="0">
            </div>
            <div class="col-6 col-lg-3">
              <label class="small-muted mb-1">Sale Price</label>
              <input id="eSale" type="number" class="form-control" value="0">
            </div>
            <div class="col-6 col-lg-3">
              <label class="small-muted mb-1">Cash Received</label>
              <input id="eCash" type="number" class="form-control" value="0">
            </div>
            <div class="col-6 col-lg-3">
              <label class="small-muted mb-1">Payment Mode</label>
              <select id="ePayMode" class="form-select">
                <option>Cash</option>
                <option>Bank Transfer</option>
                <option>Card</option>
                <option>Other</option>
              </select>
            </div>

            <div class="col-12 col-lg-6">
              <div class="card p-3" style="border-radius:16px">
                <div class="d-flex justify-content-between">
                  <div class="small-muted">Profit</div>
                  <div class="fw-semibold" id="eProfit">0</div>
                </div>
                <div class="d-flex justify-content-between mt-2">
                  <div class="small-muted">Pending</div>
                  <div class="fw-semibold" id="ePending">0</div>
                </div>
              </div>
            </div>

            <div class="col-12 col-lg-6">
              <label class="small-muted mb-1">Booking Status</label>
              <select id="eStatus" class="form-select">
                <option>Issued</option>
                <option>On Hold</option>
                <option>Cancelled</option>
                <option>Refund</option>
              </select>

              <button id="btnSaveEdit" class="btn btn-primary w-100 mt-3">Save Changes</button>
              <div class="small-muted mt-2" id="editMsg"></div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /************ CONFIG ************/
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzCgHh6YSK75UKdX53uib5YBDBhlk0RZdpV9p4uNqO44LdQPcxNkZqNF_qaHbv-S-3aNQ/exec";

    /************ STATE ************/
    let SESSION = null; // {token, user:{username,role,branch}}
    let chDailySale = null;

    const $ = (id)=>document.getElementById(id);

    function setMsg(el, text, type="muted"){
      el.innerHTML = text ? text : "";
      el.style.color = (type==="bad") ? "var(--bad)" : (type==="good" ? "var(--good)" : "var(--muted)");
    }

    function money(n){
      n = Number(n||0);
      return n.toLocaleString(undefined,{minimumFractionDigits:0, maximumFractionDigits:0});
    }

    function toISODate(yyyyMMddHHmmss){
      // if already yyyy-mm-dd...
      if(!yyyyMMddHHmmss) return "";
      const s = String(yyyyMMddHHmmss);
      if(s.length>=10 && s[4]==="-" && s[7]==="-") return s.slice(0,10);
      return "";
    }

    async function api(action, data={}){
      if(action!=="login"){
        if(!SESSION?.token) throw new Error("Not logged in");
        data.token = SESSION.token;
      }
      data.action = action;

      const body = new URLSearchParams(data);
      const res = await fetch(WEBAPP_URL, { method:"POST", body });
      const json = await res.json();
      if(!json.ok) throw new Error(json.error || "API error");
      return json;
    }

    function saveSession(){
      localStorage.setItem("TA_SESSION", JSON.stringify(SESSION));
    }
    function loadSession(){
      try{
        const raw = localStorage.getItem("TA_SESSION");
        if(!raw) return null;
        return JSON.parse(raw);
      }catch(e){ return null; }
    }
    function clearSession(){
      localStorage.removeItem("TA_SESSION");
      SESSION=null;
    }

    function showTab(key){
      document.querySelectorAll("#tabs .nav-link").forEach(b=>b.classList.remove("active"));
      document.querySelector(`#tabs .nav-link[data-tab="${key}"]`)?.classList.add("active");

      ["dash","bookings","add","customers","packages"].forEach(k=>{
        const el = document.querySelector(`#tab-${k}`);
        if(el) el.classList.toggle("hidden", k!==key);
      });
    }

    function setWhoAmI(){
      const u = SESSION?.user;
      $("whoami").textContent = u ? `${u.username} ‚Ä¢ ${u.role.toUpperCase()} ‚Ä¢ ${u.branch}` : "";
      $("btnLogout").classList.toggle("hidden", !u);
      $("addBranchShow").textContent = u?.role==="admin" ? "Select in Add (auto uses Branch field if added later)" : (u?.branch || "");
    }

    function fillBranchFilter(){
      const u = SESSION.user;
      const sel = $("branchFilter");
      sel.innerHTML = "";
      if(u.role==="admin"){
        sel.innerHTML += `<option value="">ALL</option>
                          <option value="Shahzad">Shahzad</option>
                          <option value="Madni">Madni</option>
                          <option value="Usman">Usman</option>
                          <option value="Tahir">Tahir</option>`;
      }else{
        sel.innerHTML = `<option value="${u.branch}">${u.branch}</option>`;
      }
    }

    /************ DASHBOARD ************/
    function renderCards(stats){
      const cards = [
        {label:"Total Bookings", val:stats.totalBookings},
        {label:"Total Sale", val:money(stats.totalSale)},
        {label:"Total Profit", val:money(stats.totalProfit)},
        {label:"Total Pending", val:money(stats.totalPending)},
        {label:"Today Bookings", val:stats.todayBookings},
        {label:"This Month Sale", val:money(stats.monthSale)},
      ];

      $("dashCards").innerHTML = cards.map(c=>`
        <div class="col-6 col-lg-2">
          <div class="card p-3 h-100">
            <div class="small-muted">${c.label}</div>
            <div class="fs-5 fw-bold mt-1">${c.val}</div>
          </div>
        </div>
      `).join("");
    }

    function renderDailySaleChart(labels, values){
      const ctx = $("chDailySale");
      if(chDailySale) chDailySale.destroy();

      chDailySale = new Chart(ctx, {
        type: "line",
        data: { labels, datasets: [{ label:"Sale", data: values, tension:.35 }] },
        options: {
          responsive:true,
          plugins:{ legend:{ display:false } },
          scales:{
            x:{ ticks:{ color:"#9fb2d3" }, grid:{ color:"rgba(255,255,255,.06)" } },
            y:{ ticks:{ color:"#9fb2d3" }, grid:{ color:"rgba(255,255,255,.06)" } }
          }
        }
      });
    }

    async function loadDashboard(){
      const out = await api("dashboard",{});
      renderCards(out.stats);
      $("dashMeta").textContent = `${out.user.role.toUpperCase()} ‚Ä¢ ${out.user.branch}`;
      renderDailySaleChart(out.charts.dailySale.labels, out.charts.dailySale.values);
    }

    /************ SEARCH / TABLE ************/
    function badgeStatus(s){
      s = (s||"").toLowerCase();
      let cls="bg-secondary";
      if(s.includes("issued")) cls="bg-success";
      else if(s.includes("hold")) cls="bg-warning text-dark";
      else if(s.includes("cancel")) cls="bg-danger";
      else if(s.includes("refund")) cls="bg-info text-dark";
      return `<span class="badge ${cls}">${(s||"").toUpperCase()}</span>`;
    }

    function rowActionsHtml(isAdmin, sheet, rowIndex){
      const viewBtn = `<button class="btn btn-sm btn-outline-light me-1" onclick="openView('${sheet}',${rowIndex})">View</button>`;
      const editBtn = isAdmin ? `<button class="btn btn-sm btn-primary me-1" onclick="openEdit('${sheet}',${rowIndex})">Edit</button>` : "";
      const delBtn  = isAdmin ? `<button class="btn btn-sm btn-danger" onclick="doDelete('${sheet}',${rowIndex})">Delete</button>` : "";
      return `${viewBtn}${editBtn}${delBtn}`;
    }

    function renderRows(list){
      const isAdmin = SESSION.user.role==="admin";
      $("rows").innerHTML = list.map(r=>{
        const d=r.data;
        return `
          <tr>
            <td>${d.Branch}</td>
            <td class="mono">${d.InvoiceNo}</td>
            <td>${d.CustomerName}</td>
            <td class="mono">${d.Mobile}</td>
            <td class="mono">${d.PNR}</td>
            <td class="mono">${money(d.SalePrice)}</td>
            <td class="mono">${money(d.Profit)}</td>
            <td class="mono">${money(d.Pending)}</td>
            <td>${badgeStatus(d.BookingStatus)}</td>
            <td class="small-muted mono">${d.DateTime || ""}</td>
            <td class="text-end">${rowActionsHtml(isAdmin, r.sheet, r.rowIndex)}</td>
          </tr>
        `;
      }).join("");
      $("count").textContent = `${list.length} record(s)`;
    }

    async function runSearch(){
      setMsg($("searchMsg"), "Searching...", "muted");
      const data = {
        q: $("q").value.trim(),
        fromDate: $("fromDate").value,
        toDate: $("toDate").value,
        branch: $("branchFilter").value
      };
      const out = await api("search", data);
      renderRows(out.results);
      setMsg($("searchMsg"), out.count ? "Done ‚úÖ" : "No records found", out.count ? "good" : "muted");
    }

    /************ VIEW / EDIT / DELETE ************/
    const viewModal = new bootstrap.Modal(document.getElementById("modalView"));
    const editModal = new bootstrap.Modal(document.getElementById("modalEdit"));

    window.openView = async (sheet,rowIndex)=>{
      const out = await api("getRow",{sheet,rowIndex});
      const d = out.data;

      $("viewBody").innerHTML = `
        <div class="row g-3">
          ${Object.keys(d).map(k=>`
            <div class="col-12 col-md-6">
              <div class="card p-3">
                <div class="small-muted">${k}</div>
                <div class="fw-semibold">${(d[k]??"")}</div>
              </div>
            </div>
          `).join("")}
        </div>
      `;
      viewModal.show();
    };

    function calcProfitPending(cost, sale, cash){
      cost=Number(cost||0); sale=Number(sale||0); cash=Number(cash||0);
      return { profit: sale-cost, pending: sale-cash };
    }

    function fillEdit(d){
      $("eCustomerName").value = d.CustomerName || "";
      $("eMobile").value = d.Mobile || "";
      $("ePNR").value = d.PNR || "";
      $("eTripType").value = d.TripType || "One Way";
      $("eTravelDate").value = toISODate(d.TravelDate);
      $("eReturnDate").value = toISODate(d.ReturnDate);
      $("eAirline").value = d.Airline || "";
      $("eCost").value = Number(d.CostPrice||0);
      $("eSale").value = Number(d.SalePrice||0);
      $("eCash").value = Number(d.CashReceived||0);
      $("ePayMode").value = d.PaymentMode || "Cash";
      $("eStatus").value = d.BookingStatus || "Issued";
      updateEditCalc();
    }

    function updateEditCalc(){
      const r = calcProfitPending($("eCost").value,$("eSale").value,$("eCash").value);
      $("eProfit").textContent = money(r.profit);
      $("ePending").textContent = money(r.pending);
    }

    window.openEdit = async (sheet,rowIndex)=>{
      if(SESSION.user.role!=="admin"){ alert("Admin only"); return; }
      setMsg($("editMsg"), "");
      $("eSheet").textContent = sheet;
      $("eRow").textContent = rowIndex;

      const out = await api("getRow",{sheet,rowIndex});
      fillEdit(out.data);
      editModal.show();
    };

    window.doDelete = async (sheet,rowIndex)=>{
      if(SESSION.user.role!=="admin"){ alert("Admin only"); return; }
      if(!confirm(`Delete booking?\nSheet: ${sheet}\nRow: ${rowIndex}`)) return;

      await api("delete",{sheet,rowIndex});
      alert("Deleted ‚úÖ");
      await runSearch();
      await loadDashboard();
    };

    $("btnSaveEdit").addEventListener("click", async ()=>{
      try{
        setMsg($("editMsg"), "Saving...", "muted");
        const sheet = $("eSheet").textContent;
        const rowIndex = $("eRow").textContent;

        const payload = {
          sheet, rowIndex,
          customerName: $("eCustomerName").value.trim(),
          mobile: $("eMobile").value.trim(),
          pnr: $("ePNR").value.trim(),
          tripType: $("eTripType").value,
          travelDate: $("eTravelDate").value,
          returnDate: $("eReturnDate").value,
          airline: $("eAirline").value.trim(),
          costPrice: $("eCost").value,
          salePrice: $("eSale").value,
          cashReceived: $("eCash").value,
          paymentMode: $("ePayMode").value,
          bookingStatus: $("eStatus").value
        };

        await api("update", payload);
        setMsg($("editMsg"), "Saved ‚úÖ", "good");
        await runSearch();
        await loadDashboard();
        setTimeout(()=>editModal.hide(), 600);
      }catch(e){
        setMsg($("editMsg"), e.message, "bad");
      }
    });

    ["eCost","eSale","eCash"].forEach(id=>{
      $(id).addEventListener("input", updateEditCalc);
    });

    /************ ADD BOOKING ************/
    function updateAddCalc(){
      const r = calcProfitPending($("aCost").value,$("aSale").value,$("aCash").value);
      $("aProfit").textContent = money(r.profit);
      $("aPending").textContent = money(r.pending);
    }
    ["aCost","aSale","aCash"].forEach(id=>{
      $(id).addEventListener("input", updateAddCalc);
    });

    $("btnAdd").addEventListener("click", async ()=>{
      try{
        setMsg($("addMsg"), "Saving...", "muted");

        const u = SESSION.user;
        const payload = {
          // for admin: you can later add a dropdown for branch in UI (optional)
          branch: u.role==="admin" ? ( $("branchFilter").value || "Shahzad") : u.branch,
          customerName: $("aCustomerName").value.trim(),
          mobile: $("aMobile").value.trim(),
          pnr: $("aPNR").value.trim(),
          tripType: $("aTripType").value,
          travelDate: $("aTravelDate").value,
          returnDate: $("aReturnDate").value,
          airline: $("aAirline").value.trim(),
          costPrice: $("aCost").value,
          salePrice: $("aSale").value,
          cashReceived: $("aCash").value,
          paymentMode: $("aPayMode").value,
          bookingStatus: $("aStatus").value
        };

        await api("add", payload);
        setMsg($("addMsg"), "Saved ‚úÖ", "good");

        // Clear basic fields
        ["aCustomerName","aMobile","aPNR","aAirline"].forEach(id=>$(id).value="");
        ["aCost","aSale","aCash"].forEach(id=>$(id).value=0);
        updateAddCalc();

        await loadDashboard();
        showTab("bookings");
        await runSearch();
      }catch(e){
        setMsg($("addMsg"), e.message, "bad");
      }
    });

    /************ CUSTOMERS ************/
    $("btnLoadCustomers").addEventListener("click", async ()=>{
      try{
        setMsg($("custMsg"), "Loading...", "muted");
        const out = await api("search",{ q:"", branch:$("branchFilter").value });
        const map = new Map(); // mobile => {name,mobile,branch,last}
        out.results.forEach(r=>{
          const d=r.data;
          const key = (d.Mobile||"").trim() || (d.CustomerName||"").trim();
          if(!key) return;
          const current = map.get(key);
          if(!current || (d.DateTime||"") > (current.last||"")){
            map.set(key,{ name:d.CustomerName, mobile:d.Mobile, branch:d.Branch, last:d.DateTime });
          }
        });
        const list = Array.from(map.values()).sort((a,b)=>(b.last||"").localeCompare(a.last||""));

        $("custRows").innerHTML = list.map(x=>`
          <tr>
            <td>${x.name||""}</td>
            <td class="mono">${x.mobile||""}</td>
            <td>${x.branch||""}</td>
            <td class="small-muted mono">${x.last||""}</td>
          </tr>
        `).join("");

        setMsg($("custMsg"), `${list.length} customer(s) loaded ‚úÖ`, "good");
      }catch(e){
        setMsg($("custMsg"), e.message, "bad");
      }
    });

    /************ LOGIN / LOGOUT ************/
    $("btnLogin").addEventListener("click", async ()=>{
      try{
        setMsg($("loginMsg"), "Logging in...", "muted");
        const out = await api("login", {
          username: $("loginUser").value.trim(),
          password: $("loginPass").value.trim()
        });
        SESSION = { token: out.token, user: out.user };
        saveSession();

        $("viewLogin").classList.add("hidden");
        $("viewApp").classList.remove("hidden");

        setWhoAmI();
        fillBranchFilter();
        await loadDashboard();
        showTab("dash");
        setMsg($("loginMsg"), "", "muted");
      }catch(e){
        setMsg($("loginMsg"), e.message, "bad");
      }
    });

    $("btnLogout").addEventListener("click", async ()=>{
      try{
        if(SESSION?.token){
          await api("logout",{});
        }
      }catch(e){}
      clearSession();
      $("viewApp").classList.add("hidden");
      $("viewLogin").classList.remove("hidden");
      setWhoAmI();
    });

    $("btnRefresh").addEventListener("click", async ()=>{
      await loadDashboard();
      await runSearch();
    });

    $("btnSearch").addEventListener("click", runSearch);

    // Tabs
    document.querySelectorAll("#tabs .nav-link").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        showTab(btn.dataset.tab);
      });
    });

    // Init calc
    updateAddCalc();

    // Auto-login if session exists
    (async function init(){
      const s = loadSession();
      if(!s?.token) return;
      SESSION=s;

      try{
        $("viewLogin").classList.add("hidden");
        $("viewApp").classList.remove("hidden");
        setWhoAmI();
        fillBranchFilter();
        await loadDashboard();
        showTab("dash");
        await runSearch();
      }catch(e){
        clearSession();
        $("viewApp").classList.add("hidden");
        $("viewLogin").classList.remove("hidden");
        setMsg($("loginMsg"), "Session expired. Please login again.", "bad");
      }
    })();
  </script>
</body>
</html>

