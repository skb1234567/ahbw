<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Travel Agency WebApp</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --primary: #1e40af;
      --primary-dark: #1d3696;
      --secondary: #0d9488;
      --accent: #fdba74;
      --light-bg: #f8fafc;
      --card-bg: #ffffff;
      --shadow: 0 4px 20px rgba(0,0,0,0.05);
      --border-radius: 16px;
    }

    body {
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      font-family: 'Segoe UI', system-ui, sans-serif;
      color: #1e293b;
      overflow-x: hidden;
      position: relative;
    }

    /* Side Menu - Hidden by default */
    .side-menu {
      position: fixed;
      top: 120px;
      left: 0;
      z-index: 1050;
      width: 50px;
      background: white;
      border-right: 1px solid #e2e8f0;
      box-shadow: 4px 0 20px rgba(0,0,0,0.1);
      padding: 10px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      transition: all 0.3s ease;
      opacity: 0;
      pointer-events: none;
    }
    .side-menu.show {
      opacity: 1;
      pointer-events: all;
    }
    .side-menu:hover {
      width: 200px;
    }
    .side-menu-item {
      width: 100%;
      padding: 12px 15px;
      text-align: center;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 0.9rem;
    }
    .side-menu-item:hover {
      background: var(--primary);
      color: white;
    }
    .side-menu-item i {
      font-size: 1.2rem;
    }
    .side-menu-item span {
      display: none;
      white-space: nowrap;
    }
    .side-menu:hover .side-menu-item span {
      display: inline;
    }

    /* Slideshow */
    .hero-slideshow {
      position: relative;
      height: 350px;
      border-radius: var(--border-radius);
      overflow: hidden;
      margin-bottom: 2rem;
      box-shadow: var(--shadow);
    }
    .slide {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      transition: opacity 0.5s ease;
      background-size: cover;
      background-position: center;
    }
    .slide.active {
      opacity: 1;
    }
    .slide-content {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
      color: white;
      padding: 2rem;
    }
    .slide-title {
      font-size: 2.2rem;
      font-weight: 800;
      margin: 0;
    }
    .slide-subtitle {
      font-size: 1.2rem;
      opacity: 0.9;
    }

    /* Header */
    .app-header {
      background: white;
      border-radius: var(--border-radius);
      padding: 1rem 1.5rem;
      box-shadow: var(--shadow);
      margin-bottom: 1.5rem;
    }

    .navbar-brand {
      font-weight: 700;
      font-size: 1.5rem;
      color: var(--primary);
    }

    .card {
      border: 0;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      background: var(--card-bg);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.08);
    }

    .btn {
      border-radius: 12px;
      font-weight: 600;
      padding: 0.6rem 1.25rem;
    }

    .btn-primary {
      background-color: var(--primary);
      border-color: var(--primary);
    }
    .btn-primary:hover {
      background-color: var(--primary-dark);
      border-color: var(--primary-dark);
    }

    .btn-success {
      background-color: var(--secondary);
      border-color: var(--secondary);
    }

    .badge {
      border-radius: 999px;
      font-weight: 600;
    }

    .nav-pills .nav-link {
      border-radius: 12px;
      padding: 0.6rem 1.25rem;
      font-weight: 600;
      color: #475569;
      transition: all 0.25s ease;
    }

    .nav-pills .nav-link.active {
      background-color: var(--primary);
      color: white;
    }

    .nav-pills .nav-link:hover:not(.active) {
      background-color: #f1f5f9;
    }

    .small-muted {
      font-size: 0.85rem;
      color: #64748b;
    }

    .table thead th {
      white-space: nowrap;
      font-weight: 600;
      color: #334155;
    }

    .table-hover tbody tr:hover {
      background-color: #f8fafc;
    }

    /* Dashboard stat cards */
    .stat-card {
      text-align: center;
      padding: 1.25rem;
    }
    .stat-card .title {
      font-size: 0.9rem;
      font-weight: 600;
      color: #64748b;
      margin-bottom: 0.5rem;
    }
    .stat-card .value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
    }

    .section-title {
      font-weight: 700;
      font-size: 1.25rem;
      color: var(--primary);
      margin-bottom: 0.75rem;
    }

    .section-subtitle {
      color: #64748b;
      font-size: 0.9rem;
      margin-bottom: 1.25rem;
    }

    .form-control, .form-select {
      border-radius: 10px;
      border: 1px solid #cbd5e1;
      padding: 0.6rem 1rem;
    }

    .form-control:focus, .form-select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.15);
    }

    @media (max-width: 768px) {
      .hero-slideshow { height: 250px; }
      .slide-title { font-size: 1.5rem; }
      .slide-subtitle { font-size: 1rem; }
      .side-menu {
        top: 80px;
        width: 40px;
      }
      .side-menu:hover {
        width: 160px;
      }
    }

    .fade-in {
      animation: fadeIn 0.6s ease forwards;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .header-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      margin-right: 12px;
    }
  </style>
</head>
<body>
  <!-- Side Menu - Initially Hidden -->
  <div class="side-menu" id="sideMenu">
    <div class="side-menu-item" onclick="switchTab('dash')">
      <i>üìä</i><span>Dashboard</span>
    </div>
    <div class="side-menu-item" onclick="switchTab('add')">
      <i>‚ûï</i><span>Add Booking</span>
    </div>
    <div class="side-menu-item" onclick="switchTab('search')">
      <i>üîç</i><span>Search Records</span>
    </div>
    <div class="side-menu-item" onclick="switchTab('recycle')">
      <i>üóëÔ∏è</i><span>Recycle Bin</span>
    </div>
    <div class="side-menu-item text-danger" id="sideLogout">
      <i>üö™</i><span>Logout</span>
    </div>
  </div>

  <div class="container-fluid px-4">
    <!-- SLIDESHOW SECTION -->
    <div class="hero-slideshow mb-4 rounded-3 overflow-hidden">
      <div class="slide active" style="background-image: url('https://placehold.co/1200x400/0d9488/white?text=Explore Pakistan')">
        <div class="slide-content">
          <h2 class="slide-title">Explore Pakistan</h2>
          <p class="slide-subtitle">Mountains ‚Ä¢ Deserts ‚Ä¢ Coastlines</p>
        </div>
      </div>
      <div class="slide" style="background-image: url('https://placehold.co/1200x400/0d9488/white?text=Hunza+Valley')">
        <div class="slide-content">
          <h2 class="slide-title">Hunza Valley</h2>
          <p class="slide-subtitle">Where Heaven Meets Earth</p>
        </div>
      </div>
      <div class="slide" style="background-image: url('https://placehold.co/1200x400/fdba74/white?text=Karachi+Coast')">
        <div class="slide-content">
          <h2 class="slide-title">Karachi Coast</h2>
          <p class="slide-subtitle">Sun, Sand & Sea</p>
        </div>
      </div>
    </div>

    <!-- HEADER -->
    <div class="app-header d-flex align-items-center justify-content-between mb-4 fade-in">
      <div class="d-flex align-items-center">
        <div class="header-icon">‚úàÔ∏è</div>
        <div>
          <h4 class="mb-0">Travel Agency WebApp</h4>
          <div class="small-muted" id="whoami">Not logged in</div>
        </div>
      </div>
      <div>
        <button class="btn btn-outline-secondary d-none" id="btnLogout">Logout</button>
      </div>
    </div>

    <!-- LOGIN -->
    <div class="card p-4 mb-4 fade-in" id="loginCard">
      <h5 class="mb-3 text-center">üîê Agency Login</h5>
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label small text-muted">Username</label>
          <input class="form-control" id="lgUser" placeholder="e.g., admin">
        </div>
        <div class="col-md-4">
          <label class="form-label small text-muted">Password</label>
          <input class="form-control" id="lgPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" type="password">
        </div>
        <div class="col-md-4 d-grid align-self-end">
          <button class="btn btn-primary" id="btnLogin">Login to Dashboard</button>
        </div>
      </div>
      <div class="mt-3 text-danger small text-center" id="loginMsg"></div>
    </div>

    <!-- APP -->
    <div id="app" class="d-none">
      <!-- NAV TABS -->
      <ul class="nav nav-pills gap-2 mb-4 p-2 bg-gray-100 rounded-3 fade-in">
        <li class="nav-item"><button class="nav-link active" data-tab="dash">üìä Dashboard</button></li>
        <li class="nav-item"><button class="nav-link" data-tab="add">‚ûï Add Booking</button></li>
        <li class="nav-item"><button class="nav-link" data-tab="search">üîç Search Records</button></li>
        <li class="nav-item d-none" id="tabRecycleWrap"><button class="nav-link" data-tab="recycle">üóëÔ∏è Recycle Bin</button></li>
      </ul>

      <!-- DASHBOARD -->
      <div id="tab-dash" class="fade-in">
        <div class="row g-3 mb-4" id="dashCards"></div>
        <div class="row g-4">
          <div class="col-lg-6">
            <div class="card p-4 h-100">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                  <h6 class="section-title">Today Sale vs Profit</h6>
                  <div class="small-muted">Auto-calculated from live data</div>
                </div>
                <button class="btn btn-sm btn-outline-primary" id="btnRefreshDash">üîÑ Refresh</button>
              </div>
              <canvas id="chToday" height="140"></canvas>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="card p-4 h-100">
              <h6 class="section-title">Month Sale vs Profit</h6>
              <div class="small-muted mb-2">Updated in real-time</div>
              <canvas id="chMonth" height="140"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- ADD BOOKING -->
      <div id="tab-add" class="d-none fade-in">
        <div class="card p-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <h5 class="section-title">‚ûï Add New Booking</h5>
              <p class="small-muted mb-0">All fields update profit & pending automatically</p>
            </div>
            <span class="badge text-bg-light px-3 py-2" id="invHint">Invoice: Auto-generated</span>
          </div>

          <div class="row g-3">
            <div class="col-md-3 d-none" id="adminBranchWrap">
              <label class="form-label small text-muted">Branch</label>
              <select class="form-select" id="bkBranch">
                <option value="Shahzad">Shahzad</option>
                <option value="Madni">Madni</option>
                <option value="Usman">Usman</option>
                <option value="Tahir">Tahir</option>
              </select>
            </div>

            <div class="col-md-3">
              <label class="form-label small text-muted">Customer Name</label>
              <input class="form-control" id="bkCustomer" placeholder="e.g., Ali Khan">
            </div>
            <div class="col-md-3">
              <label class="form-label small text-muted">Mobile</label>
              <input class="form-control" id="bkMobile" placeholder="05...">
            </div>
            <div class="col-md-3">
              <label class="form-label small text-muted">PNR / Ticket #</label>
              <input class="form-control" id="bkPNR" placeholder="ABC123">
            </div>

            <div class="col-md-3">
              <label class="form-label small text-muted">Trip Type</label>
              <select class="form-select" id="bkTrip">
                <option>One Way</option>
                <option>Two Way</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label small text-muted">Travel Date</label>
              <input class="form-control" id="bkTravel" type="date">
            </div>
            <div class="col-md-3">
              <label class="form-label small text-muted">Return Date</label>
              <input class="form-control" id="bkReturn" type="date">
            </div>
            <div class="col-md-3">
              <label class="form-label small text-muted">Airline</label>
              <select class="form-select" id="bkTrip">
                <option>Qatar Airways</option>
                <option>Saudia</option>
              </select>
            </div>

            <div class="col-md-3">
              <label class="form-label small text-muted">Cost Price (SAR)</label>
              <input class="form-control" id="bkCost" placeholder="15,000">
            </div>
            <div class="col-md-3">
              <label class="form-label small text-muted">Sale Price (SAR)</label>
              <input class="form-control" id="bkSale" placeholder="20,000">
            </div>
            <div class="col-md-3">
              <label class="form-label small text-muted">Cash Received</label>
              <input class="form-control" id="bkCash" placeholder="0" value="0">
            </div>

            <div class="col-md-3">
              <label class="form-label small text-muted">Payment Mode</label>
              <select class="form-select" id="bkPayMode">
                <option>Cash</option>
                <option>Bank</option>
                <option>Card</option>
                <option>Other</option>
              </select>
            </div>

            <div class="col-md-3">
              <label class="form-label small text-muted">Status</label>
              <select class="form-select" id="bkStatus">
                <option>On Hold</option>
                <option>Issued</option>
              </select>
            </div>

            <div class="col-md-3">
              <label class="form-label small text-muted">Profit (auto)</label>
              <input class="form-control bg-light" id="bkProfit" placeholder="‚Äî" readonly>
            </div>

            <div class="col-md-3">
              <label class="form-label small text-muted">Pending (auto)</label>
              <input class="form-control bg-light" id="bkPending" placeholder="‚Äî" readonly>
            </div>

            <div class="col-12 d-grid mt-2">
              <button class="btn btn-success btn-lg" id="btnAdd">‚úÖ Save & Confirm Booking</button>
            </div>
          </div>

          <div class="mt-3 text-center small" id="addMsg"></div>
        </div>
      </div>

      <!-- SEARCH -->
      <div id="tab-search" class="d-none fade-in">
        <div class="card p-4 mb-4">
          <h6 class="section-title">üîç Advanced Search</h6>
          <div class="row g-3 align-items-end">
            <div class="col-md-4">
              <input class="form-control" id="srQuery" placeholder="PNR, Mobile, or Customer Name">
            </div>
            <div class="col-md-2 d-none" id="adminBranchFilterWrap">
              <select class="form-select" id="srBranch">
                <option value="ALL">All Branches</option>
                <option value="Shahzad">Shahzad</option>
                <option value="Madni">Madni</option>
                <option value="Usman">Usman</option>
                <option value="Tahir">Tahir</option>
              </select>
            </div>
            <div class="col-md-2">
              <select class="form-select" id="srDateMode">
                <option value="">All Time</option>
                <option value="TODAY">Today</option>
                <option value="MONTH">This Month</option>
              </select>
            </div>
            <div class="col-md-2 d-grid">
              <button class="btn btn-primary" id="btnSearch">üîé Search Records</button>
            </div>
          </div>
          <div class="small text-muted mt-2">üí° Admin: Edit/Delete actions appear in results table.</div>
        </div>

        <div class="card p-4">
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>Branch</th><th>Inv</th><th>Name</th><th>Mobile</th><th>PNR</th><th>Trip</th>
                  <th>Travel</th><th>Return</th><th>Airline</th>
                  <th>Cost</th><th>Sale</th><th>Profit</th><th>Cash</th><th>Pending</th>
                  <th>Pay</th><th>Status</th><th>DateTime</th>
                  <th id="thAdminActions" class="d-none">Actions</th>
                </tr>
              </thead>
              <tbody id="srBody"></tbody>
            </table>
          </div>
          <div class="small text-muted text-center mt-3" id="srCount"></div>
        </div>
      </div>

      <!-- RECYCLE BIN -->
      <div id="tab-recycle" class="d-none fade-in">
        <div class="card p-4 mb-4">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="section-title">üóëÔ∏è Recycle Bin</h6>
              <p class="small-muted mb-0">Restore accidentally deleted bookings</p>
            </div>
            <button class="btn btn-outline-primary" id="btnLoadDeleted">üì• Load Deleted</button>
          </div>
        </div>

        <div class="card p-4">
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>Branch</th><th>Inv</th><th>Name</th><th>Mobile</th><th>PNR</th><th>Sale</th><th>Status</th><th>Restore</th>
                </tr>
              </thead>
              <tbody id="delBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- EDIT MODAL -->
  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content" style="border-radius:16px">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title text-primary">‚úèÔ∏è Edit Booking</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body pt-0">
          <div class="small text-muted mb-3 p-2 bg-light rounded" id="editMeta">Loading...</div>

          <div class="row g-3">
            <div class="col-md-4">
              <input class="form-control" id="edCustomer" placeholder="Customer Name">
            </div>
            <div class="col-md-4">
              <input class="form-control" id="edMobile" placeholder="Mobile">
            </div>
            <div class="col-md-4">
              <input class="form-control" id="edPNR" placeholder="PNR / Ticket">
            </div>

            <div class="col-md-4">
              <select class="form-select" id="edTrip">
                <option>One Way</option>
                <option>Two Way</option>
              </select>
            </div>
            <div class="col-md-4">
              <input class="form-control" id="edTravel" type="date">
            </div>
            <div class="col-md-4">
              <input class="form-control" id="edReturn" type="date">
            </div>

            <div class="col-md-4">
              <input class="form-control" id="edAirline" placeholder="Airline">
            </div>
            <div class="col-md-4">
              <input class="form-control" id="edCost" placeholder="Cost Price">
            </div>
            <div class="col-md-4">
              <input class="form-control" id="edSale" placeholder="Sale Price">
            </div>

            <div class="col-md-4">
              <input class="form-control" id="edCash" placeholder="Cash Received">
            </div>
            <div class="col-md-4">
              <select class="form-select" id="edPay">
                <option>Cash</option><option>Bank</option><option>Card</option><option>Other</option>
              </select>
            </div>
            <div class="col-md-4">
              <select class="form-select" id="edStatus">
                <option>On Hold</option><option>Issued</option><option>Deleted</option>
              </select>
            </div>

            <div class="col-md-6">
              <input class="form-control bg-light" id="edProfit" placeholder="Profit (auto)" readonly>
              <div class="small text-muted mt-1">Sale ‚àí Cost</div>
            </div>
            <div class="col-md-6">
              <input class="form-control bg-light" id="edPending" placeholder="Pending (auto)" readonly>
              <div class="small text-muted mt-1">Sale ‚àí Cash</div>
            </div>
          </div>

          <div class="text-danger small mt-3 text-center" id="edMsg"></div>
        </div>
        <div class="modal-footer border-0 pt-0">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" id="btnSaveEdit">üíæ Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // =============== SLIDESHOW ===============
    let currentSlide = 0;
    let slides = document.querySelectorAll('.slide');
    const slideInterval = 5000;

    function showSlide(index) {
      slides.forEach((slide, i) => {
        slide.classList.toggle('active', i === index);
      });
    }

    function nextSlide() {
      currentSlide = (currentSlide + 1) % slides.length;
      showSlide(currentSlide);
    }

    // Auto-rotate
    setInterval(nextSlide, slideInterval);

    // =============== SIDE MENU ===============
    function switchTab(tabId) {
      document.querySelectorAll('.nav-link').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
      
      ['dash','add','search','recycle'].forEach(t => {
        const el = document.getElementById(`tab-${t}`);
        if (el) el.classList.toggle('d-none', t !== tabId);
      });
    }

    // =============== LOGIN FUNCTIONALITY ===============
    const $ = (id)=>document.getElementById(id);
    let state = { username: "", role: "", branch: "" };
    let charts = { today: null, month: null };
    let editCtx = { sheet:"", rowNumber:0 };

    function saveSession(u){ localStorage.setItem("ta_session", JSON.stringify(u)); }
    function loadSession(){
      try { return JSON.parse(localStorage.getItem("ta_session")||"null"); } catch(e){ return null; }
    }
    function clearSession(){ localStorage.removeItem("ta_session"); }

    async function api(action, data){
      const body = new URLSearchParams({ action, ...data });
      const r = await fetch("https://script.google.com/macros/s/AKfycbyoqxlvdSGvTWGYKp9sQuB2U9lfDzGKY6VfuzUahwNoDTgxY2aChR5V_fvaHB-mw00/exec", { method:"POST", body });
      return await r.json();
    }

    function money(x){
      const n = Number(String(x||"0").replace(/,/g,""));
      return isNaN(n) ? "0" : n.toLocaleString();
    }
    function calcProfitPending(cost, sale, cash){
      cost = Number(String(cost||"0").replace(/,/g,""))||0;
      sale = Number(String(sale||"0").replace(/,/g,""))||0;
      cash = Number(String(cash||"0").replace(/,/g,""))||0;
      return { profit: sale-cost, pending: sale-cash };
    }

    document.querySelectorAll(".nav-link").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".nav-link").forEach(x=>x.classList.remove("active"));
        btn.classList.add("active");
        const tab = btn.getAttribute("data-tab");
        ["dash","add","search","recycle"].forEach(t=>{
          const el = $(`tab-${t}`);
          if(el) el.classList.toggle("d-none", t!==tab);
        });
      });
    });

    $("btnLogin").addEventListener("click", async ()=>{
      $("loginMsg").textContent = "";
      const username = $("lgUser").value.trim();
      const password = $("lgPass").value.trim();
      if(!username || !password){ $("loginMsg").textContent = "‚ö†Ô∏è Enter username & password"; return; }

      const res = await api("login", { username, password });
      if(!res.ok){ $("loginMsg").textContent = res.message || "Login failed"; return; }

      state = res.user;
      saveSession(state);
      afterLogin();
    });

    $("btnLogout").addEventListener("click", ()=>{
      clearSession();
      location.reload();
    });

    document.getElementById('sideLogout').addEventListener('click', () => {
      clearSession();
      location.reload();
    });

    function afterLogin(){
      // Show side menu after login
      document.getElementById('sideMenu').classList.add('show');
      
      $("loginCard").classList.add("d-none");
      $("app").classList.remove("d-none");
      $("btnLogout").classList.remove("d-none");
      $("whoami").textContent = `Logged in: ${state.username} | ${state.role} | ${state.branch}`;

      const isAdmin = String(state.role).toLowerCase()==="admin";
      $("adminBranchWrap").classList.toggle("d-none", !isAdmin);
      $("adminBranchFilterWrap").classList.toggle("d-none", !isAdmin);
      $("thAdminActions").classList.toggle("d-none", !isAdmin);
      $("tabRecycleWrap").classList.toggle("d-none", !isAdmin);

      document.querySelector('[data-tab="dash"]').click();
      refreshDash();
    }

    $("btnRefreshDash").addEventListener("click", refreshDash);

    async function refreshDash(){
      const res = await api("dashboard", { username: state.username, role: state.role, branch: state.branch });
      if(!res.ok) return;

      const d = res.dash;
      const cards = [
        { title:"Today Sale", val: money(d.todaySale), icon:"üí∞" },
        { title:"Today Profit", val: money(d.todayProfit), icon:"üìà" },
        { title:"Month Sale", val: money(d.monthSale), icon:"üìä" },
        { title:"Month Profit", val: money(d.monthProfit), icon:"üíé" },
        { title:"Pending Total", val: money(d.pendingTotal), icon:"‚è≥" },
        { title:"Issued Today", val: String(d.issuedToday), icon:"‚úÖ" },
        { title:"On Hold Today", val: String(d.holdToday), icon:"‚è∏Ô∏è" },
      ];

      $("dashCards").innerHTML = cards.map(c=>
        `<div class="col-md-3 col-6 fade-in" style="animation-delay:${cards.indexOf(c)*0.1}s">
          <div class="card stat-card">
            <div class="title">${c.title}</div>
            <div class="value">${c.val}</div>
            <div class="mt-1">${c.icon}</div>
          </div>
        </div>`
      ).join("");

      const ctxT = $("chToday");
      const ctxM = $("chMonth");
      if(charts.today) charts.today.destroy();
      if(charts.month) charts.month.destroy();

      charts.today = new Chart(ctxT, {
        type:"bar",
        data:{ labels:["Sale","Profit"], datasets:[{ data:[d.todaySale, d.todayProfit], backgroundColor: ["#93c5fd", "#34d399"] }] },
        options:{ 
          responsive:true, 
          plugins: { legend: { display: false } }, 
          scales: { y: { beginAtZero: true } } 
        }
      });

      charts.month = new Chart(ctxM, {
        type:"bar",
        data:{ labels:["Sale","Profit"], datasets:[{ data:[d.monthSale, d.monthProfit], backgroundColor: ["#60a5fa", "#10b981"] }] },
        options:{ 
          responsive:true, 
          plugins: { legend: { display: false } }, 
          scales: { y: { beginAtZero: true } } 
        }
      });
    }

    ["bkCost","bkSale","bkCash"].forEach(id=>{
      $(id).addEventListener("input", ()=>{
        const r = calcProfitPending($("bkCost").value, $("bkSale").value, $("bkCash").value);
        $("bkProfit").value = money(r.profit);
        $("bkPending").value = money(r.pending);
      });
    });

    $("btnAdd").addEventListener("click", async ()=>{
      $("addMsg").textContent = "";
      const isAdmin = String(state.role).toLowerCase()==="admin";

      const payload = {
        username: state.username,
        role: state.role,
        targetBranch: isAdmin ? $("bkBranch").value : "",
        customerName: $("bkCustomer").value.trim(),
        mobile: $("bkMobile").value.trim(),
        pnr: $("bkPNR").value.trim(),
        tripType: $("bkTrip").value,
        travelDate: $("bkTravel").value,
        returnDate: $("bkReturn").value,
        airline: $("bkAirline").value.trim(),
        costPrice: $("bkCost").value.trim(),
        salePrice: $("bkSale").value.trim(),
        cashReceived: $("bkCash").value.trim(),
        paymentMode: $("bkPayMode").value,
        bookingStatus: $("bkStatus").value
      };

      const res = await api("addBooking", payload);
      if(!res.ok){ 
        $("addMsg").textContent = "‚ùå " + (res.message || "Save failed"); 
        $("addMsg").className="mt-2 small text-danger";
        return; 
      }

      $("addMsg").textContent = `‚úÖ Saved! Invoice: ${res.invoice}`;
      $("addMsg").className="mt-2 small text-success";

      ["bkCustomer","bkMobile","bkPNR","bkAirline","bkCost","bkSale"].forEach(x=>$(x).value="");
      $("bkCash").value="0";
      $("bkProfit").value="";
      $("bkPending").value="";
      refreshDash();
    });

    $("btnSearch").addEventListener("click", runSearch);

    async function runSearch(includeDeleted=false){
      $("srBody").innerHTML = "";
      $("srCount").textContent = "‚è≥ Loading...";
      const isAdmin = String(state.role).toLowerCase()==="admin";

      const payload = {
        username: state.username,
        query: $("srQuery").value.trim(),
        dateMode: $("srDateMode").value,
        branch: isAdmin ? $("srBranch").value : "",
        includeDeleted: includeDeleted ? "1" : ""
      };

      const res = await api("search", payload);
      if(!res.ok){ $("srCount").textContent = "‚ùå " + (res.message || "Search failed"); return; }

      const rows = res.rows || [];
      $("srCount").textContent = `‚úÖ Found ${rows.length} record${rows.length!==1?'s':''}`;

      $("srBody").innerHTML = rows.map(r=>{
        const d = r.data || {};
        return `<tr>
          <td>${d["Branch"]||r.sheet}</td>
          <td>${d["Invoice No"]||""}</td>
          <td>${d["Customer Name"]||""}</td>
          <td>${d["Mobile"]||""}</td>
          <td>${d["PNR / Ticket"]||""}</td>
          <td>${d["Trip Type"]||""}</td>
          <td>${d["Travel Date"]||""}</td>
          <td>${d["Return Date"]||""}</td>
          <td>${d["Airline"]||""}</td>
          <td class="text-end">${money(d["Cost Price"])}</td>
          <td class="text-end">${money(d["Sale Price"])}</td>
          <td class="text-end text-success">${money(d["Profit"])}</td>
          <td class="text-end">${money(d["Cash Received"])}</td>
          <td class="text-end text-warning">${money(d["Pending"])}</td>
          <td>${d["Payment Mode"]||""}</td>
          <td><span class="badge ${d["Booking Status"]==="Issued"?"bg-success":"bg-warning"}">${d["Booking Status"]||""}</span></td>
          <td>${d["Date & Time"]||""}</td>
          ${isAdmin ? `<td>
            <button class="btn btn-sm btn-outline-primary" onclick="openEdit('${r.sheet}', ${r.rowNumber})">‚úèÔ∏è</button>
            <button class="btn btn-sm btn-outline-danger" onclick="softDelete('${r.sheet}', ${r.rowNumber})">üóëÔ∏è</button>
            <button class="btn btn-sm btn-outline-success" onclick="waMsg('${d["Mobile"]||""}','${d["PNR / Ticket"]||""}','${d["Customer Name"]||""}','${d["Travel Date"]||""}','${money(d["Sale Price"])}','${money(d["Pending"])}')">üì±</button>
          </td>` : ""} 
        </tr>`;
      }).join("");
    }

    window.softDelete = async (sheet, rowNumber)=>{
      if(!confirm("‚ö†Ô∏è Soft delete this booking?")) return;
      const res = await api("deleteBooking", { username: state.username, sheet, rowNumber });
      if(!res.ok){ alert("‚ùå "+(res.message||"Failed")); return; }
      alert("‚úÖ Deleted to recycle bin");
      runSearch();
      refreshDash();
    };

    window.openEdit = async (sheet, rowNumber)=>{
      const res = await api("getRow", { username: state.username, sheet, rowNumber });
      if(!res.ok){ alert("‚ùå "+(res.message||"Fetch failed")); return; }

      editCtx = { sheet, rowNumber };
      const d = res.data;

      $("editMeta").textContent = `Sheet: ${sheet} ‚Ä¢ Row: ${rowNumber} ‚Ä¢ Invoice: ${d["Invoice No"] || "N/A"}`;

      $("edCustomer").value = d["Customer Name"]||"";
      $("edMobile").value = d["Mobile"]||"";
      $("edPNR").value = d["PNR / Ticket"]||"";
      $("edTrip").value = d["Trip Type"]||"One Way";
      $("edTravel").value = d["Travel Date"]||"";
      $("edReturn").value = d["Return Date"]||"";
      $("edAirline").value = d["Airline"]||"";
      $("edCost").value = d["Cost Price"]||"";
      $("edSale").value = d["Sale Price"]||"";
      $("edCash").value = d["Cash Received"]||"0";
      $("edPay").value = d["Payment Mode"]||"Cash";
      $("edStatus").value = d["Booking Status"]||"On Hold";

      const rr = calcProfitPending($("edCost").value, $("edSale").value, $("edCash").value);
      $("edProfit").value = money(rr.profit);
      $("edPending").value = money(rr.pending);

      $("edMsg").textContent = "";
      new bootstrap.Modal(document.getElementById("editModal")).show();
    };

    ["edCost","edSale","edCash"].forEach(id=>{
      $(id).addEventListener("input", ()=>{
        const r = calcProfitPending($("edCost").value, $("edSale").value, $("edCash").value);
        $("edProfit").value = money(r.profit);
        $("edPending").value = money(r.pending);
      });
    });

    $("btnSaveEdit").addEventListener("click", async ()=>{
      $("edMsg").textContent = "";
      const p = {
        username: state.username,
        sheet: editCtx.sheet,
        rowNumber: editCtx.rowNumber,
        customerName: $("edCustomer").value.trim(),
        mobile: $("edMobile").value.trim(),
        pnr: $("edPNR").value.trim(),
        tripType: $("edTrip").value,
        travelDate: $("edTravel").value,
        returnDate: $("edReturn").value,
        airline: $("edAirline").value.trim(),
        costPrice: $("edCost").value.trim(),
        salePrice: $("edSale").value.trim(),
        cashReceived: $("edCash").value.trim(),
        paymentMode: $("edPay").value,
        bookingStatus: $("edStatus").value
      };

      const res = await api("updateBooking", p);
      if(!res.ok){ $("edMsg").textContent = "‚ùå "+(res.message||"Update failed"); return; }

      bootstrap.Modal.getInstance(document.getElementById("editModal")).hide();
      runSearch();
      refreshDash();
      setTimeout(()=>alert("‚úÖ Booking updated successfully!"), 100);
    });

    $("btnLoadDeleted").addEventListener("click", async ()=>{
      const res = await api("search", {
        username: state.username,
        query: "",
        dateMode: "",
        branch: "ALL",
        includeDeleted: "1"
      });
      if(!res.ok){ alert("‚ùå "+(res.message||"Load failed")); return; }

      const del = (res.rows||[]).filter(x => String((x.data||{})["Booking Status"]||"").toLowerCase()==="deleted");
      $("delBody").innerHTML = del.map(r=>{
        const d = r.data||{};
        return `<tr>
          <td>${r.sheet}</td>
          <td>${d["Invoice No"]||""}</td>
          <td>${d["Customer Name"]||""}</td>
          <td>${d["Mobile"]||""}</td>
          <td>${d["PNR / Ticket"]||""}</td>
          <td class="text-end">${money(d["Sale Price"])}</td>
          <td><span class="badge bg-danger">Deleted</span></td>
          <td><button class="btn btn-sm btn-success" onclick="restoreRow('${r.sheet}', ${r.rowNumber})">‚Ü©Ô∏è Restore</button></td>
        </tr>`;
      }).join("");
    });

    window.restoreRow = async (sheet, rowNumber)=>{
      if(!confirm("Restore this booking to 'On Hold' status?")) return;
      const res = await api("restoreBooking", { username: state.username, sheet, rowNumber, restoreTo:"On Hold" });
      if(!res.ok){ alert("‚ùå "+(res.message||"Restore failed")); return; }
      alert("‚úÖ Restored successfully");
      $("btnLoadDeleted").click();
      runSearch();
      refreshDash();
    };

    window.waMsg = (mobile, pnr, name, travel, sale, pending)=>{
      const text = `‚úàÔ∏è *Booking Invoice*\n\nüë§ Name: ${name}\nüé´ PNR: ${pnr}\nüìÖ Travel: ${travel}\nüí∏ Total: ${sale}\n‚è≥ Pending: ${pending}`;
      const url = `https://wa.me/${mobile}?text=${encodeURIComponent(text)}`;
      window.open(url, "_blank");
    };

    (function init(){
      const sess = loadSession();
      if(sess && sess.username){
        state = sess;
        afterLogin();
      }
    })();
  </script>
</body>
</html>

